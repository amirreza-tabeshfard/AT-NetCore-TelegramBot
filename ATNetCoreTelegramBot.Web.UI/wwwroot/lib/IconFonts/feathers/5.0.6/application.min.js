"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Feathers=void 0;const version_1=__importDefault(require("./version")),events_1=require("events"),commons_1=require("@feathersjs/commons"),hooks_1=require("@feathersjs/hooks"),events_2=require("./events"),hooks_2=require("./hooks"),service_1=require("./service"),hooks_3=require("./hooks"),debug=(0,commons_1.createDebug)("@feathersjs/feathers");class Feathers extends events_1.EventEmitter{constructor(){super(),this.services={},this.settings={},this.mixins=[hooks_2.hookMixin,events_2.eventMixin],this.version=version_1.default,this._isSetup=!1,this.registerHooks=(0,hooks_3.enableHooks)(this),this.registerHooks({around:[events_2.eventHook]})}get(e){return this.settings[e]}set(e,s){return this.settings[e]=s,this}configure(e){return e.call(this,this),this}defaultService(e){throw new Error(`Can not find service '${e}'`)}service(e){var e=(0,commons_1.stripSlashes)(e)||"/",s=this.services[e];return void 0===s?(this.use(e,this.defaultService(e)),this.service(e)):s}_setup(){return this._isSetup=!0,Object.keys(this.services).reduce((e,s)=>e.then(()=>{const e=this.service(s);if("function"==typeof e.setup)return debug(`Setting up service for \`${s}\``),e.setup(this,s)}),Promise.resolve()).then(()=>this)}get setup(){return this._setup}set setup(e){this._setup=e[hooks_1.HOOKS]?e:(0,hooks_1.hooks)(e,(0,hooks_1.middleware)().params("server").props({app:this}))}_teardown(){return this._isSetup=!1,Object.keys(this.services).reduce((e,s)=>e.then(()=>{const e=this.service(s);if("function"==typeof e.teardown)return debug(`Tearing down service for \`${s}\``),e.teardown(this,s)}),Promise.resolve()).then(()=>this)}get teardown(){return this._teardown}set teardown(e){this._teardown=e[hooks_1.HOOKS]?e:(0,hooks_1.hooks)(e,(0,hooks_1.middleware)().params("server").props({app:this}))}use(e,s,t){if("string"!=typeof e)throw new Error(`'${e}' is not a valid service path.`);const r=(0,commons_1.stripSlashes)(e)||"/",i=s;if("function"==typeof i.service&&i.services)return Object.keys(i.services).forEach(e=>this.use(r+"/"+e,i.service(e))),this;const o=(0,service_1.wrapService)(r,s,t),n=(0,service_1.getServiceOptions)(o);for(const h of service_1.protectedMethods)if(n.methods.includes(h))throw new Error(`'${h}' on service '${r}' is not allowed as a custom method name`);return debug(`Registering new service at \`${r}\``),this.mixins.forEach(e=>e.call(this,o,r,n)),this.services[r]=o,this._isSetup&&"function"==typeof o.setup&&(debug(`Setting up service for \`${r}\``),o.setup(this,r)),this}async unuse(e){e=(0,commons_1.stripSlashes)(e)||"/";const s=this.services[e];return s&&"function"==typeof s.teardown&&await s.teardown(this,e),delete this.services[e],s}hooks(e){return e.before||e.after||e.error||e.around?this.registerHooks(e):e.setup||e.teardown?(0,hooks_1.hooks)(this,e):this.registerHooks({around:e}),this}}exports.Feathers=Feathers;