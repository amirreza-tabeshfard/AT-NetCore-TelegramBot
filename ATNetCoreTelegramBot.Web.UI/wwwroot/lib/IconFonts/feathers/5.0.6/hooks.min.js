"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.hookMixin=exports.FeathersHookManager=exports.createContext=exports.enableHooks=exports.collectHooks=exports.convertHookData=void 0;const hooks_1=require("@feathersjs/hooks"),service_1=require("./service"),types=["before","after","error","around"],isType=e=>types.includes(e);function convertHookData(e){const o={};if(Array.isArray(e))o.all=e;else if("object"!=typeof e)o.all=[e];else for(const r of Object.keys(e)){var t=e[r];o[r]=Array.isArray(t)?t:[t]}return o}function collectHooks(e,o){var{collected:e,collectedAll:t,around:r}=e.__hooks;return[...r.all||[],...r[o]||[],...t.before||[],...e[o]||[],...t.after||[]]}function enableHooks(e){return Object.defineProperty(e,"__hooks",{configurable:!0,value:{around:{},before:{},after:{},error:{},collected:{},collectedAll:{}},writable:!0}),function(t){const a=this.__hooks,n=Object.keys(t).reduce((e,o)=>{if(isType(o))return e[o]=convertHookData(t[o]),e;throw new Error(`'${o}' is not a valid hook type`)},{}),e=Object.keys(n);return e.forEach(s=>Object.keys(n[s]).forEach(e=>{var o,t=n[s][e];const r=(o=a[s])[e]||(o[e]=[]);r.push(...t),"all"===e?((a.before[e]||a.error[e])&&(o=(0,hooks_1.collect)({before:a.before[e]||[],error:a.error[e]||[]}),a.collectedAll.before=[o]),a.after[e]&&(t=(0,hooks_1.collect)({after:a.after[e]||[]}),a.collectedAll.after=[t])):(a.before[e]||a.after[e]||a.error[e])&&(o=(0,hooks_1.collect)({before:a.before[e]||[],after:a.after[e]||[],error:a.error[e]||[]}),a.collected[e]=[o])})),this}}function createContext(e,o,t={}){const r=e[o].createContext;if("function"!=typeof r)throw new Error("Can not create context for method "+o);return r(t)}exports.convertHookData=convertHookData,exports.collectHooks=collectHooks,exports.enableHooks=enableHooks,exports.createContext=createContext;class FeathersHookManager extends hooks_1.HookManager{constructor(e,o){super(),this.app=e,this.method=o,this._middleware=[]}collectMiddleware(e,o){var t=collectHooks(this.app,this.method),o=super.collectMiddleware(e,o),e=collectHooks(e,this.method);return[...t,...o,...e]}initializeContext(e,o,t){const r=super.initializeContext(e,o,t);return r.params=r.params||{},r}middleware(e){return this._middleware.push(...e),this}}function hookMixin(r,s,e){if("function"==typeof r.hooks)return r;const o=(0,service_1.getHookMethods)(r,e);e=o.reduce((e,o)=>{var t=service_1.defaultServiceArguments[o]||["data","params"];return e[o]=new FeathersHookManager(this,o).params(...t).props({app:this,path:s,method:o,service:r,event:null,type:"around",get statusCode(){var e;return null==(e=this.http)?void 0:e.status},set statusCode(e){this.http=this.http||{},this.http.status=e}}),e},{});const a=enableHooks(r);return(0,hooks_1.hooks)(r,e),r.hooks=function(t){return t.before||t.after||t.error||t.around?a.call(this,t):Array.isArray(t)?(0,hooks_1.hooks)(this,t):(Object.keys(t).forEach(e=>{const o=(0,hooks_1.getManager)(this[e]);if(!(o instanceof FeathersHookManager))throw new Error(`Method ${e} is not a Feathers hooks enabled service method`);o.middleware(t[e])}),this)},r}exports.FeathersHookManager=FeathersHookManager,exports.hookMixin=hookMixin;